<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="../../style/control.css">
    <link rel="stylesheet" href="http://maxiang.qiniudn.com/app/css/app.css?1408270014">
    <title>博客</title>
</head>
<body class="body">
    <div class="blog-item"><div id="" class="note-content" style="padding-left: 35px; padding-right: 35px; padding-bottom: 273px;">
                        <div id="wmd-preview" class="preview-content"></div>
                    <div id="wmd-preview-section-928" class="wmd-preview-section preview-content">

</div><div id="wmd-preview-section-1025" class="wmd-preview-section preview-content">

<h2 id="elasticsearch220的错误">ElasticSearch2.2.0的错误</h2>

<p><code>NotSerializableExceptionWrapper</code></p></div><div id="wmd-preview-section-310" class="wmd-preview-section preview-content">

<pre class="prettyprint hljs-dark"><code class="language-java hljs"><span class="hljs-comment line-number">1.</span>Client client = <span class="hljs-keyword">null</span>;<br><span class="hljs-comment line-number">2.</span><span class="hljs-keyword">try</span> {<br><span class="hljs-comment line-number">3.</span>    client = TransportClient.builder().build()<br><span class="hljs-comment line-number">4.</span>            .addTransportAddress(<span class="hljs-keyword">new</span> InetSocketTransportAddress(InetAddress.getByName(ESHOST), ESPORT));<br><span class="hljs-comment line-number">5.</span>} <span class="hljs-keyword">catch</span> (UnknownHostException e) {<br><span class="hljs-comment line-number">6.</span>    e.printStackTrace();<br><span class="hljs-comment line-number">7.</span>}<br></code></pre>

<p>用以上方式连接ElasticSearch多次执行script更新操作时会产生以下错误</p></div><div id="wmd-preview-section-769" class="wmd-preview-section preview-content">

<pre class="prettyprint hljs-dark"><code class="language-bash hljs"><span class="hljs-comment line-number">1.</span>Caused by: NotSerializableExceptionWrapper[sun/reflect/MethodAccessorImpl]; nested: NotSerializableExceptionWrapper[sun.reflect.MethodAccessorImpl];<br><span class="hljs-comment line-number">2.</span>    at sun.misc.Unsafe.defineClass(Native Method)<br><span class="hljs-comment line-number">3.</span>    at sun.reflect.ClassDefiner.defineClass(ClassDefiner.java:<span class="hljs-number">63</span>)<br><span class="hljs-comment line-number">4.</span>    at sun.reflect.MethodAccessorGenerator<span class="hljs-variable">$1</span>.run(MethodAccessorGenerator.java:<span class="hljs-number">399</span>)<br><span class="hljs-comment line-number">5.</span>    at sun.reflect.MethodAccessorGenerator<span class="hljs-variable">$1</span>.run(MethodAccessorGenerator.java:<span class="hljs-number">396</span>)<br><span class="hljs-comment line-number">6.</span>    at java.security.AccessController.doPrivileged(Native Method)<br><span class="hljs-comment line-number">7.</span>    at sun.reflect.MethodAccessorGenerator.generate(MethodAccessorGenerator.java:<span class="hljs-number">395</span>)<br><span class="hljs-comment line-number">8.</span>    at sun.reflect.MethodAccessorGenerator.generateMethod(MethodAccessorGenerator.java:<span class="hljs-number">77</span>)<br><span class="hljs-comment line-number">9.</span>    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class="hljs-number">46</span>)<br><span class="hljs-comment line-number">10.</span>    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="hljs-number">43</span>)<br><span class="hljs-comment line-number">11.</span>    at java.lang.reflect.Method.invoke(Method.java:<span class="hljs-number">606</span>)<br><span class="hljs-comment line-number">12.</span>    at org.codehaus.groovy.reflection.CachedMethod.invoke(CachedMethod.java:<span class="hljs-number">93</span>)<br><span class="hljs-comment line-number">13.</span>    at groovy.lang.MetaMethod.doMethodInvoke(MetaMethod.java:<span class="hljs-number">325</span>)<br><span class="hljs-comment line-number">14.</span>    at org.codehaus.groovy.runtime.metaclass.ClosureMetaClass.invokeMethod(ClosureMetaClass.java:<span class="hljs-number">294</span>)<br><span class="hljs-comment line-number">15.</span>    at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:<span class="hljs-number">1019</span>)<br><span class="hljs-comment line-number">16.</span>    at groovy.lang.Closure.call(Closure.java:<span class="hljs-number">426</span>)<br><span class="hljs-comment line-number">17.</span>    at groovy.lang.Closure.call(Closure.java:<span class="hljs-number">442</span>)<br><span class="hljs-comment line-number">18.</span>    at org.codehaus.groovy.runtime.DefaultGroovyMethods.each(DefaultGroovyMethods.java:<span class="hljs-number">2030</span>)<br><span class="hljs-comment line-number">19.</span>    at org.codehaus.groovy.runtime.DefaultGroovyMethods.each(DefaultGroovyMethods.java:<span class="hljs-number">2015</span>)<br><span class="hljs-comment line-number">20.</span>    at org.codehaus.groovy.runtime.DefaultGroovyMethods.each(DefaultGroovyMethods.java:<span class="hljs-number">2056</span>)<br><span class="hljs-comment line-number">21.</span>    at org.codehaus.groovy.runtime.dgm<span class="hljs-variable">$162</span>.doMethodInvoke(Unknown Source)<br><span class="hljs-comment line-number">22.</span>    at <span class="hljs-number">72</span>c719f0c11150b19d5fa4b87f36873f0e9aa3ce.run(<span class="hljs-number">72</span>c719f0c11150b19d5fa4b87f36873f0e9aa3ce:<span class="hljs-number">1</span>)<br><span class="hljs-comment line-number">23.</span>    at org.elasticsearch.script.groovy.GroovyScriptEngineService<span class="hljs-variable">$GroovyScript</span><span class="hljs-variable">$1</span>.run(GroovyScriptEngineService.java:<span class="hljs-number">311</span>)<br><span class="hljs-comment line-number">24.</span>    at java.security.AccessController.doPrivileged(Native Method)<br><span class="hljs-comment line-number">25.</span>    at org.elasticsearch.script.groovy.GroovyScriptEngineService<span class="hljs-variable">$GroovyScript</span>.run(GroovyScriptEngineService.java:<span class="hljs-number">308</span>)<br><span class="hljs-comment line-number">26.</span>    ... <span class="hljs-number">13</span> more<br><span class="hljs-comment line-number">27.</span>Caused by: NotSerializableExceptionWrapper[sun.reflect.MethodAccessorImpl]<br><span class="hljs-comment line-number">28.</span>    at java.net.URLClassLoader<span class="hljs-variable">$1</span>.run(URLClassLoader.java:<span class="hljs-number">366</span>)<br><span class="hljs-comment line-number">29.</span>    at java.net.URLClassLoader<span class="hljs-variable">$1</span>.run(URLClassLoader.java:<span class="hljs-number">355</span>)<br><span class="hljs-comment line-number">30.</span>    at java.security.AccessController.doPrivileged(Native Method)<br><span class="hljs-comment line-number">31.</span>    at java.net.URLClassLoader.findClass(URLClassLoader.java:<span class="hljs-number">354</span>)<br><span class="hljs-comment line-number">32.</span>    at java.lang.ClassLoader.loadClass(ClassLoader.java:<span class="hljs-number">425</span>)<br><span class="hljs-comment line-number">33.</span>    at groovy.lang.GroovyClassLoader.loadClass(GroovyClassLoader.java:<span class="hljs-number">677</span>)<br><span class="hljs-comment line-number">34.</span>    at groovy.lang.GroovyClassLoader<span class="hljs-variable">$InnerLoader</span>.loadClass(GroovyClassLoader.java:<span class="hljs-number">425</span>)<br><span class="hljs-comment line-number">35.</span>    at groovy.lang.GroovyClassLoader.loadClass(GroovyClassLoader.java:<span class="hljs-number">787</span>)<br><span class="hljs-comment line-number">36.</span>    at groovy.lang.GroovyClassLoader.loadClass(GroovyClassLoader.java:<span class="hljs-number">775</span>)<br><span class="hljs-comment line-number">37.</span>    ... <span class="hljs-number">37</span> more<br><span class="hljs-comment line-number">38.</span><br></code></pre>

<p>估计是服务端的连接没有释放导致的问题，更新到2.2.1版本就正常了</p>

<p>执行的脚本:</p></div><div id="wmd-preview-section-742" class="wmd-preview-section preview-content">

<pre class="prettyprint hljs-dark"><code class="language-java hljs"><span class="hljs-comment line-number">1.</span>String script = <span class="hljs-string">"if (!ctx._source.eventType.contains('"</span> + message.getLt() + <span class="hljs-string">"')) { "</span> +<br><span class="hljs-comment line-number">2.</span>                <span class="hljs-string">"ctx._source.eventStatusList &lt;&lt; "</span> +<br><span class="hljs-comment line-number">3.</span>                    <span class="hljs-string">"["</span> +<br><span class="hljs-comment line-number">4.</span>                    <span class="hljs-string">"'eventName' : '"</span> + message.getLt() + <span class="hljs-string">"',"</span> +<br><span class="hljs-comment line-number">5.</span>                    <span class="hljs-string">"'source' : '"</span> + message.getSource() + <span class="hljs-string">"',"</span> +<br><span class="hljs-comment line-number">6.</span>                    <span class="hljs-string">"'firstTime' : "</span> + time + <span class="hljs-string">","</span> +<br><span class="hljs-comment line-number">7.</span>                    <span class="hljs-string">"'lastTime' : "</span> + time + <span class="hljs-string">","</span> +<br><span class="hljs-comment line-number">8.</span>                    <span class="hljs-string">"'totalNum' : 1 ,"</span> +<br><span class="hljs-comment line-number">9.</span>                    <span class="hljs-string">"'dayNumList' : [['day' : '"</span> + format + <span class="hljs-string">"','num': 1 ]],"</span> +<br><span class="hljs-comment line-number">10.</span>                    <span class="hljs-string">"'days' : ['"</span> + format + <span class="hljs-string">"']"</span> +<br><span class="hljs-comment line-number">11.</span>                    <span class="hljs-string">"]; "</span> +<br><span class="hljs-comment line-number">12.</span>                    <span class="hljs-string">" ctx._source.eventType &lt;&lt; '"</span> + message.getLt() + <span class="hljs-string">"';"</span> +<br><span class="hljs-comment line-number">13.</span>                    <span class="hljs-string">"} else {"</span> +<br><span class="hljs-comment line-number">14.</span>                        <span class="hljs-string">"ctx._source.eventStatusList.each { events -&gt; "</span> +<br><span class="hljs-comment line-number">15.</span>                        <span class="hljs-string">"if ( events.eventName == '"</span> + message.getLt() + <span class="hljs-string">"'){"</span> +<br><span class="hljs-comment line-number">16.</span>                            <span class="hljs-string">"events.totalNum += 1 ; "</span> +<br><span class="hljs-comment line-number">17.</span>                            <span class="hljs-string">"events.lastTime = "</span> + time + <span class="hljs-string">" ; "</span> +<br><span class="hljs-comment line-number">18.</span>                            <span class="hljs-string">"events.source = '"</span> + message.getSource() + <span class="hljs-string">"'; "</span> +<br><span class="hljs-comment line-number">19.</span>                            <span class="hljs-string">"if ( !events.days.contains('"</span> + format + <span class="hljs-string">"')) { "</span> +<br><span class="hljs-comment line-number">20.</span>                                <span class="hljs-string">"events.days &lt;&lt; '"</span>+format+<span class="hljs-string">"' ; "</span> +<br><span class="hljs-comment line-number">21.</span>                                <span class="hljs-string">"events.dayNumList &lt;&lt; ['day':'"</span>+format+<span class="hljs-string">"','num':1] ;"</span> +<br><span class="hljs-comment line-number">22.</span>                            <span class="hljs-string">" } else { "</span> +<br><span class="hljs-comment line-number">23.</span>                                    <span class="hljs-string">"events.dayNumList.each { "</span> +<br><span class="hljs-comment line-number">24.</span>                                        <span class="hljs-string">"la -&gt; if ( la.day == '"</span> + format+<span class="hljs-string">"')"</span> +<br><span class="hljs-comment line-number">25.</span>                                                <span class="hljs-string">"{"</span> +<br><span class="hljs-comment line-number">26.</span>                                                    <span class="hljs-string">"la.num += 1;"</span> +<br><span class="hljs-comment line-number">27.</span>                                                 <span class="hljs-string">"} "</span> +<br><span class="hljs-comment line-number">28.</span>                                    <span class="hljs-string">"} "</span> +<br><span class="hljs-comment line-number">29.</span>                            <span class="hljs-string">"} "</span> +<br><span class="hljs-comment line-number">30.</span>                        <span class="hljs-string">"}"</span> +<br><span class="hljs-comment line-number">31.</span>                    <span class="hljs-string">"}"</span> +<br><span class="hljs-comment line-number">32.</span>                <span class="hljs-string">"}"</span>;<br><span class="hljs-comment line-number">33.</span>        UpdateRequest updateRequest = <span class="hljs-keyword">new</span> UpdateRequest(INDEXNAME, TYPENAME, message.getUid() + <span class="hljs-string">""</span>)<br><span class="hljs-comment line-number">34.</span>                .script(<span class="hljs-keyword">new</span> Script(script, ScriptService.ScriptType.INLINE, <span class="hljs-string">"groovy"</span>, <span class="hljs-keyword">null</span>))<br></code></pre>

<p>为了维护这样一个JSON</p></div><div id="wmd-preview-section-729" class="wmd-preview-section preview-content">

<pre class="prettyprint hljs-dark"><code class="language-json hljs"><span class="hljs-comment line-number">1.</span>{<br><span class="hljs-comment line-number">2.</span>  "<span class="hljs-attribute">userId</span>": <span class="hljs-value"><span class="hljs-number">2246476</span></span>,<br><span class="hljs-comment line-number">3.</span>  "<span class="hljs-attribute">utype</span>": <span class="hljs-value"><span class="hljs-string">"C"</span></span>,<br><span class="hljs-comment line-number">4.</span>  "<span class="hljs-attribute">eventType</span>": <span class="hljs-value">[<br><span class="hljs-comment line-number">5.</span>    <span class="hljs-string">"unresponse"</span>,<br><span class="hljs-comment line-number">6.</span>    <span class="hljs-string">"register"</span>,<br><span class="hljs-comment line-number">7.</span>    <span class="hljs-string">"talk"</span>,<br><span class="hljs-comment line-number">8.</span>    <span class="hljs-string">"imservice"</span><br><span class="hljs-comment line-number">9.</span>  ]</span>,<br><span class="hljs-comment line-number">10.</span>  "<span class="hljs-attribute">eventStatusList</span>": <span class="hljs-value">[<br><span class="hljs-comment line-number">11.</span>    {<br><span class="hljs-comment line-number">12.</span>      "<span class="hljs-attribute">source</span>": <span class="hljs-value"><span class="hljs-string">"UNKONW"</span></span>,<br><span class="hljs-comment line-number">13.</span>      "<span class="hljs-attribute">eventName</span>": <span class="hljs-value"><span class="hljs-string">"unresponse"</span></span>,<br><span class="hljs-comment line-number">14.</span>      "<span class="hljs-attribute">firstTime</span>": <span class="hljs-value"><span class="hljs-string">"1452009600000"</span></span>,<br><span class="hljs-comment line-number">15.</span>      "<span class="hljs-attribute">lastTime</span>": <span class="hljs-value"><span class="hljs-number">1452009600000</span></span>,<br><span class="hljs-comment line-number">16.</span>      "<span class="hljs-attribute">totalNum</span>": <span class="hljs-value"><span class="hljs-number">10830</span></span>,<br><span class="hljs-comment line-number">17.</span>      "<span class="hljs-attribute">days</span>": <span class="hljs-value">[<br><span class="hljs-comment line-number">18.</span>        <span class="hljs-string">"2016-01-06"</span><br><span class="hljs-comment line-number">19.</span>      ]</span>,<br><span class="hljs-comment line-number">20.</span>      "<span class="hljs-attribute">dayNumList</span>": <span class="hljs-value">[<br><span class="hljs-comment line-number">21.</span>        {<br><span class="hljs-comment line-number">22.</span>          "<span class="hljs-attribute">day</span>": <span class="hljs-value"><span class="hljs-string">"2016-01-06"</span></span>,<br><span class="hljs-comment line-number">23.</span>          "<span class="hljs-attribute">num</span>": <span class="hljs-value"><span class="hljs-number">10830</span><br><span class="hljs-comment line-number">24.</span>        </span>}<br><span class="hljs-comment line-number">25.</span>      ]<br><span class="hljs-comment line-number">26.</span>    </span>},<br><span class="hljs-comment line-number">27.</span>    {<br><span class="hljs-comment line-number">28.</span>      "<span class="hljs-attribute">eventName</span>": <span class="hljs-value"><span class="hljs-string">"register"</span></span>,<br><span class="hljs-comment line-number">29.</span>      "<span class="hljs-attribute">source</span>": <span class="hljs-value"><span class="hljs-string">"UNKONW"</span></span>,<br><span class="hljs-comment line-number">30.</span>      "<span class="hljs-attribute">firstTime</span>": <span class="hljs-value"><span class="hljs-number">1454256000000</span></span>,<br><span class="hljs-comment line-number">31.</span>      "<span class="hljs-attribute">lastTime</span>": <span class="hljs-value"><span class="hljs-number">1454256000000</span></span>,<br><span class="hljs-comment line-number">32.</span>      "<span class="hljs-attribute">totalNum</span>": <span class="hljs-value"><span class="hljs-number">10831</span></span>,<br><span class="hljs-comment line-number">33.</span>      "<span class="hljs-attribute">dayNumList</span>": <span class="hljs-value">[<br><span class="hljs-comment line-number">34.</span>        {<br><span class="hljs-comment line-number">35.</span>          "<span class="hljs-attribute">day</span>": <span class="hljs-value"><span class="hljs-string">"2016-02-01"</span></span>,<br><span class="hljs-comment line-number">36.</span>          "<span class="hljs-attribute">num</span>": <span class="hljs-value"><span class="hljs-number">10831</span><br><span class="hljs-comment line-number">37.</span>        </span>}<br><span class="hljs-comment line-number">38.</span>      ]</span>,<br><span class="hljs-comment line-number">39.</span>      "<span class="hljs-attribute">days</span>": <span class="hljs-value">[<br><span class="hljs-comment line-number">40.</span>        <span class="hljs-string">"2016-02-01"</span><br><span class="hljs-comment line-number">41.</span>      ]<br><span class="hljs-comment line-number">42.</span>    </span>},<br><span class="hljs-comment line-number">43.</span>    {<br><span class="hljs-comment line-number">44.</span>      "<span class="hljs-attribute">eventName</span>": <span class="hljs-value"><span class="hljs-string">"talk"</span></span>,<br><span class="hljs-comment line-number">45.</span>      "<span class="hljs-attribute">source</span>": <span class="hljs-value"><span class="hljs-string">"UNKONW"</span></span>,<br><span class="hljs-comment line-number">46.</span>      "<span class="hljs-attribute">firstTime</span>": <span class="hljs-value"><span class="hljs-number">1452009600000</span></span>,<br><span class="hljs-comment line-number">47.</span>      "<span class="hljs-attribute">lastTime</span>": <span class="hljs-value"><span class="hljs-number">1452009600000</span></span>,<br><span class="hljs-comment line-number">48.</span>      "<span class="hljs-attribute">totalNum</span>": <span class="hljs-value"><span class="hljs-number">10830</span></span>,<br><span class="hljs-comment line-number">49.</span>      "<span class="hljs-attribute">dayNumList</span>": <span class="hljs-value">[<br><span class="hljs-comment line-number">50.</span>        {<br><span class="hljs-comment line-number">51.</span>          "<span class="hljs-attribute">day</span>": <span class="hljs-value"><span class="hljs-string">"2016-01-06"</span></span>,<br><span class="hljs-comment line-number">52.</span>          "<span class="hljs-attribute">num</span>": <span class="hljs-value"><span class="hljs-number">10830</span><br><span class="hljs-comment line-number">53.</span>        </span>}<br><span class="hljs-comment line-number">54.</span>      ]</span>,<br><span class="hljs-comment line-number">55.</span>      "<span class="hljs-attribute">days</span>": <span class="hljs-value">[<br><span class="hljs-comment line-number">56.</span>        <span class="hljs-string">"2016-01-06"</span><br><span class="hljs-comment line-number">57.</span>      ]<br><span class="hljs-comment line-number">58.</span>    </span>},<br><span class="hljs-comment line-number">59.</span>    {<br><span class="hljs-comment line-number">60.</span>      "<span class="hljs-attribute">eventName</span>": <span class="hljs-value"><span class="hljs-string">"imservice"</span></span>,<br><span class="hljs-comment line-number">61.</span>      "<span class="hljs-attribute">source</span>": <span class="hljs-value"><span class="hljs-string">"UNKONW"</span></span>,<br><span class="hljs-comment line-number">62.</span>      "<span class="hljs-attribute">firstTime</span>": <span class="hljs-value"><span class="hljs-number">1455552000000</span></span>,<br><span class="hljs-comment line-number">63.</span>      "<span class="hljs-attribute">lastTime</span>": <span class="hljs-value"><span class="hljs-number">1455552000000</span></span>,<br><span class="hljs-comment line-number">64.</span>      "<span class="hljs-attribute">totalNum</span>": <span class="hljs-value"><span class="hljs-number">10829</span></span>,<br><span class="hljs-comment line-number">65.</span>      "<span class="hljs-attribute">dayNumList</span>": <span class="hljs-value">[<br><span class="hljs-comment line-number">66.</span>        {<br><span class="hljs-comment line-number">67.</span>          "<span class="hljs-attribute">day</span>": <span class="hljs-value"><span class="hljs-string">"2016-02-16"</span></span>,<br><span class="hljs-comment line-number">68.</span>          "<span class="hljs-attribute">num</span>": <span class="hljs-value"><span class="hljs-number">10829</span><br><span class="hljs-comment line-number">69.</span>        </span>}<br><span class="hljs-comment line-number">70.</span>      ]</span>,<br><span class="hljs-comment line-number">71.</span>      "<span class="hljs-attribute">days</span>": <span class="hljs-value">[<br><span class="hljs-comment line-number">72.</span>        <span class="hljs-string">"2016-02-16"</span><br><span class="hljs-comment line-number">73.</span>      ]<br><span class="hljs-comment line-number">74.</span>    </span>}<br><span class="hljs-comment line-number">75.</span>  ]<br><span class="hljs-comment line-number">76.</span></span>}<br></code></pre></div><div id="wmd-preview-section-674" class="wmd-preview-section preview-content"></div><div id="wmd-preview-section-footnotes" class="preview-content"></div></div>        <!-- UY BEGIN -->
        <div id="uyan_frame" style="margin-top: 50px;"></div>
        <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=1957046"></script>
        <!-- UY END -->
    </div>
</body>
</html>